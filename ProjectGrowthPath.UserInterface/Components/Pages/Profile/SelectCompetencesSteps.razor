@using ProjectGrowthPath.Application.Service
@using ProjectGrowthPath.Application.Interfaces
@using ProjectGrowthPath.Application.State
@using ProjectGrowthPath.Domain.Entities
@using MudBlazor
@inject FirstTimeSetupService SetupService
@inject SetupStateStore StateStorage
@inject ICompetenceRepository CompetenceRepository

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (IsLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <h3>@Title</h3>
    <p>@Subtitle</p>
    <MudGrid>
        @foreach (var number in new[] { 1, 2, 3 })
        {
            <MudItem xs="12">
                <MudAutocomplete T="Competence"
                                 Label="@($"Keuze {number}")"
                                 Value="@GetSelectedCompetence(number)"
                                 ValueChanged="@(c => SelectCompetenceAsync(number, c))"
                                 SearchFunc="(val, token) => SearchForComp(val, token, GetAvailableCompetences(number))"
                                 ToStringFunc="@(c => c == null ? null : $"{c.Name} ({c.Description})")"
                                 Clearable="true" />
            </MudItem>
        }
        <MudItem xs="12" md="12">
            <MudText Class="mb-n3" Typo="Typo.body2">
                Selectie:
                @foreach (var comp in SelectedCompetences.OrderBy(k => k.Key))
                {
                    <MudChip T="string">@($"{comp.Value?.Name ?? "Niet geselecteerd"}")</MudChip>
                }
            </MudText>
        </MudItem>
    </MudGrid>

    <div class="mt-4">
        <button class="btn btn-outline-secondary me-2" @onclick="() => OnBack.InvokeAsync()">Terug</button>
        <button class="btn btn-success" @onclick="() => OnNext.InvokeAsync()" disabled="@(!CanProceed)">Volgende</button>
    </div>
}

@code {
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public string Mode { get; set; } = "interests"; // "skills" of "interests"

    private List<Competence> AllCompetences { get; set; } = new();

    private Dictionary<int, Competence> SelectedInterests => StateStorage.CurrentState.SelectedInterests;
    private Dictionary<int, Competence> SelectedSkills => StateStorage.CurrentState.SelectedSkills;

    private Dictionary<int, Competence> SelectedCompetences => Mode == "skills" ? SelectedSkills : SelectedInterests;

    private bool _isFirstRender = true;
    private bool IsLoading = true;

    private bool CanProceed => SelectedCompetences?.Count == 3
                               && SelectedCompetences.Values.Distinct().Count() == 3
                               && SelectedCompetences.Values.All(c => c != null);

    private string Title => Mode == "skills" ? "Kies 3 vaardigheden die je bezit." : "Kies 3 competenties waarin je interesse hebt.";
    private string Subtitle => "Geen zorgen, later kan je meer kiezen!";

    protected override async Task OnInitializedAsync()
    {
        AllCompetences = await CompetenceRepository.GetList();
        IsLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _isFirstRender)
        {
            await StateStorage.LoadAsync();
            _isFirstRender = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Competence GetSelectedCompetence(int number)
    {
        SelectedCompetences.TryGetValue(number, out var competence);
        return competence;
    }

    private async Task SelectCompetenceAsync(int number, Competence competence)
    {
        await SetupService.UpdateCompetenceDictionary(number, competence, Mode);
        await InvokeAsync(StateHasChanged);
    }

    private IEnumerable<Competence> GetAvailableCompetences(int currentNumber)
    {
        // Haal de huidige selectie op voor deze stap
        var selectedInThisMode = SelectedCompetences
            .Where(kvp => kvp.Key != currentNumber)
            .Select(kvp => kvp.Value)
            .Where(c => c != null)
            .ToList();

        // Haal selectie op uit de andere mode (andere stap)
        var selectedInOtherMode = (Mode == "skills" ? StateStorage.CurrentState.SelectedInterests : StateStorage.CurrentState.SelectedSkills)
            .Select(kvp => kvp.Value)
            .Where(c => c != null)
            .ToList();

        // Combineer alles wat uitgesloten moet worden
        var allExcluded = selectedInThisMode
            .Concat(selectedInOtherMode)
            .Distinct()
            .ToList();

        // Return alleen de competenties die niet geselecteerd zijn
        return AllCompetences
            .Where(c => !allExcluded.Any(ex => ex.CompetenceID == c.CompetenceID))
            .ToList();
    }

    private Task<IEnumerable<Competence>> SearchForComp(string value, CancellationToken token, IEnumerable<Competence> available)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(available);

        var result = available.Where(c => c.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
        return Task.FromResult(result);
    }
}
