@page "/profile/setup"
@using Microsoft.AspNetCore.Identity
@using ProjectGrowthPath.Application.Interfaces
@using ProjectGrowthPath.Infrastructure.Identity
@using System.Security.Claims
@using Microsoft.Build.Framework
@using ProjectGrowthPath.Application.Service
@using ProjectGrowthPath.Domain.Entities
@using ProjectGrowthPath.UserInterface.Components.Layout

@inject FirstTimeSetupService SetupService
@inject IUserProfileService ProfileService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider
@layout LoginAndRegister

@rendermode InteractiveServer
<PageTitle>Profile Set-up</PageTitle>
<div>

</div>

<EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="AddName">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <InputText @bind-Value="model.Name" placeholder="Voer je naam in" />
    <button type="submit">Profiel aanmaken</button>
</EditForm>

@code {
    private NameModel model = new();


    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            SetupService.StartSetup(Guid.Parse(userId)); // of sla het op in SetupStateStore
        }

        // Optioneel: herladen bij refresh?
        model.Name = SetupService.CurrentState?.NewUser?.Name ?? "";
    }

    private async Task HandleSubmit()
    {
        SetupService.UpdateName(model.Name);

        // Navigeren naar volgende stap in wizard, bijv. Competenties kiezen
        Navigation.NavigateTo("/profile/setup/interests");
    }

    private class NameModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Name { get; set; }
    }
}